<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>퀴즈 생성 - 파이낸셜 프리덤</title>
    <link rel="icon" href="/static/favicon.ico" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/admin/css/admin-common.css" rel="stylesheet">
</head>
<body>
<div class="admin-wrapper">
    <div th:replace="~{admin/common/sidebar :: sidebar}"></div>
    <div class="admin-content">
        <div th:replace="~{admin/common/header :: header('퀴즈 생성', 'fas fa-question-circle', null)}"></div>
        <main class="page-content">
            <div class="row mb-3">
                <div class="col-md-12 text-end">
                    <a href="/admin/quiz" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>목록으로
                    </a>
                </div>
            </div>
            <div class="container">
                <form id="quizForm">
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <!-- 기본 정보 -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">퀴즈 타입 <span class="text-danger">*</span></label>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="type" id="typeOX" value="OX" checked>
                                                <label class="form-check-label" for="typeOX">OX 퀴즈</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="type" id="typeMCQ" value="MCQ">
                                                <label class="form-check-label" for="typeMCQ">4지선다 퀴즈</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">난이도 <span class="text-danger">*</span></label>
                                            <select class="form-select" name="difficulty" required>
                                                <option value="EASY">쉬움</option>
                                                <option value="MEDIUM" selected>보통</option>
                                                <option value="HARD">어려움</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- 카테고리와 뉴스 연결 -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">카테고리 <span class="text-danger">*</span></label>
                                            <select class="form-select" name="category" required>
                                                <option value="">카테고리 선택</option>
                                                <option value="NEWS_ARTICLE" selected>뉴스 기사</option>
                                                <option value="ADMIN_CREATED">관리자 생성문제</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">연결된 뉴스 ID</label>
                                            <input type="number" class="form-control" name="newsArticleId" placeholder="뉴스 기사 선택 시 입력">
                                        </div>
                                    </div>

                                    <!-- 문제 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">문제 <span class="text-danger">*</span></label>
                                        <textarea class="form-control" name="question" rows="3" required maxlength="500" placeholder="퀴즈 문제를 입력하세요" oninput="updateCharCount('question', 500)"></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>최대 500자</span>
                                            <span id="questionCount" class="text-muted">0/500</span>
                                        </div>
                                    </div>

                                    <!-- OX 정답 영역 -->
                                    <div id="oxAnswerArea" class="mb-4">
                                        <label class="form-label fw-bold">정답 <span class="text-danger">*</span></label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="oxAnswer" id="oxTrue" value="true">
                                            <label class="form-check-label" for="oxTrue">O (참)</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="oxAnswer" id="oxFalse" value="false">
                                            <label class="form-check-label" for="oxFalse">X (거짓)</label>
                                        </div>
                                    </div>

                                    <!-- 4지선다 선택지 영역 -->
                                    <div id="mcqOptionsArea" class="mb-4 d-none">
                                        <label class="form-label fw-bold">선택지 <span class="text-danger">*</span></label>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text">①</span>
                                                    <input type="text" class="form-control" name="mcqOption1" maxlength="300" placeholder="첫 번째 선택지" oninput="updateOptionCharCount(1, 300)">
                                                    <div class="input-group-text">
                                                        <input class="form-check-input" type="radio" name="mcqCorrectIndex" value="1">
                                                    </div>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    <span id="option1Count">0/300</span>
                                                </small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text">②</span>
                                                    <input type="text" class="form-control" name="mcqOption2" maxlength="300" placeholder="두 번째 선택지" oninput="updateOptionCharCount(2, 300)">
                                                    <div class="input-group-text">
                                                        <input class="form-check-input" type="radio" name="mcqCorrectIndex" value="2">
                                                    </div>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    <span id="option2Count">0/300</span>
                                                </small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text">③</span>
                                                    <input type="text" class="form-control" name="mcqOption3" maxlength="300" placeholder="세 번째 선택지" oninput="updateOptionCharCount(3, 300)">
                                                    <div class="input-group-text">
                                                        <input class="form-check-input" type="radio" name="mcqCorrectIndex" value="3">
                                                    </div>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    <span id="option3Count">0/300</span>
                                                </small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="input-group">
                                                    <span class="input-group-text">④</span>
                                                    <input type="text" class="form-control" name="mcqOption4" maxlength="300" placeholder="네 번째 선택지" oninput="updateOptionCharCount(4, 300)">
                                                    <div class="input-group-text">
                                                        <input class="form-check-input" type="radio" name="mcqCorrectIndex" value="4">
                                                    </div>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    <span id="option4Count">0/300</span>
                                                </small>
                                            </div>
                                        </div>
                                        <div class="form-text">정답에 해당하는 선택지의 체크박스를 선택하세요</div>
                                    </div>

                                    <!-- 해설 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">해설</label>
                                        <textarea class="form-control" name="explanation" rows="4" maxlength="500" placeholder="퀴즈 해설을 입력하세요 (선택사항)" oninput="updateCharCount('explanation', 500)"></textarea>
                                        <div class="form-text d-flex justify-content-between">
                                            <span>최대 500자</span>
                                            <span id="explanationCount" class="text-muted">0/500</span>
                                        </div>
                                    </div>

                                    <!-- 버튼 -->
                                    <div class="d-flex justify-content-between">
                                        <a href="/admin/quiz" class="btn btn-secondary">취소</a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>퀴즈 저장
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </main>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/static/admin/js/admin-common.js"></script>
<script>
    $(document).ready(function() {
        $('[data-page="quiz"]').addClass('active');
        
        // 퀴즈 타입 변경 시 UI 토글
        $('input[name="type"]').change(function() {
            toggleQuizTypeUI();
        });
        
        // 카테고리 변경 시 뉴스 ID 필드 상태 변경
        $('select[name="category"]').change(function() {
            toggleNewsIdField();
        });
        
        // 폼 제출 처리
        $('#quizForm').submit(function(e) {
            e.preventDefault();
            submitQuiz();
        });
        
        toggleQuizTypeUI(); // 초기 UI 설정
        toggleNewsIdField(); // 초기 뉴스 ID 필드 설정
    });

    function toggleQuizTypeUI() {
        const type = $('input[name="type"]:checked').val();
        
        if (type === 'OX') {
            $('#oxAnswerArea').removeClass('d-none');
            $('#mcqOptionsArea').addClass('d-none');
            
            // MCQ 필드 초기화
            $('input[name^="mcqOption"]').val('');
            $('input[name="mcqCorrectIndex"]').prop('checked', false);
        } else if (type === 'MCQ') {
            $('#oxAnswerArea').addClass('d-none');
            $('#mcqOptionsArea').removeClass('d-none');
            
            // OX 필드 초기화
            $('input[name="oxAnswer"]').prop('checked', false);
        }
    }

    function toggleNewsIdField() {
        const category = $('select[name="category"]').val();
        const newsIdField = $('input[name="newsArticleId"]');
        
        if (category === 'NEWS_ARTICLE') {
            newsIdField.prop('disabled', false);
            newsIdField.attr('placeholder', '뉴스 기사 ID 입력 (선택사항)');
        } else {
            newsIdField.prop('disabled', true);
            newsIdField.val('');
            newsIdField.attr('placeholder', '관리자 생성문제는 뉴스 연결 불가');
        }
    }

    function submitQuiz() {
        const formData = new FormData(document.getElementById('quizForm'));
        const type = formData.get('type');
        
        // 데이터 구성
        const data = {
            type: type,
            difficulty: formData.get('difficulty'),
            category: formData.get('category'),
            newsArticleId: formData.get('newsArticleId') && !$('input[name="newsArticleId"]').prop('disabled') ? parseInt(formData.get('newsArticleId')) : null,
            question: formData.get('question'),
            explanation: formData.get('explanation') || null
        };

        // 타입별 데이터 추가
        if (type === 'OX') {
            if (!formData.get('oxAnswer')) {
                showToast('OX 퀴즈의 정답을 선택해주세요', 'error');
                return;
            }
            data.oxAnswer = formData.get('oxAnswer') === 'true';
        } else if (type === 'MCQ') {
            // 4지선다 유효성 검사
            const options = [
                formData.get('mcqOption1'),
                formData.get('mcqOption2'), 
                formData.get('mcqOption3'),
                formData.get('mcqOption4')
            ];
            
            if (options.some(opt => !opt || opt.trim() === '')) {
                showToast('모든 선택지를 입력해주세요', 'error');
                return;
            }
            
            if (!formData.get('mcqCorrectIndex')) {
                showToast('정답을 선택해주세요', 'error');
                return;
            }
            
            data.mcqOption1 = options[0];
            data.mcqOption2 = options[1];
            data.mcqOption3 = options[2];
            data.mcqOption4 = options[3];
            data.mcqCorrectIndex = parseInt(formData.get('mcqCorrectIndex'));
        }

        // API 호출
        $.ajax({
            url: '/admin/api/quiz',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showToast('퀴즈가 성공적으로 생성되었습니다', 'success');
                setTimeout(() => {
                    window.location.href = '/admin/quiz/' + response.id;
                }, 1500);
            },
            error: function(xhr) {
                let errorMessage = '퀴즈 생성에 실패했습니다';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.responseJSON && xhr.responseJSON.errors) {
                    // 유효성 검사 오류 처리
                    const errors = xhr.responseJSON.errors;
                    if (errors.length > 0) {
                        errorMessage = errors[0].defaultMessage;
                    }
                }
                
                showToast(errorMessage, 'error');
            }
        });
    }

    // 글자 수 카운터 업데이트 함수
    function updateCharCount(fieldName, maxLength) {
        const field = $('[name="' + fieldName + '"]');
        const currentLength = field.val().length;
        const countElement = $('#' + fieldName + 'Count');
        
        countElement.text(currentLength + '/' + maxLength);
        
        // 글자 수가 제한에 가까워지면 색상 변경
        if (currentLength >= maxLength * 0.9) {
            countElement.removeClass('text-muted').addClass('text-warning');
        } else if (currentLength >= maxLength) {
            countElement.removeClass('text-muted text-warning').addClass('text-danger');
        } else {
            countElement.removeClass('text-warning text-danger').addClass('text-muted');
        }
    }

    // 4지선다 선택지 글자 수 카운터 업데이트 함수
    function updateOptionCharCount(optionNumber, maxLength) {
        const field = $('[name="mcqOption' + optionNumber + '"]');
        const currentLength = field.val().length;
        const countElement = $('#option' + optionNumber + 'Count');
        
        countElement.text(currentLength + '/' + maxLength);
        
        // 글자 수가 제한에 가까워지면 색상 변경
        if (currentLength >= maxLength * 0.9) {
            countElement.removeClass('text-muted').addClass('text-warning');
        } else if (currentLength >= maxLength) {
            countElement.removeClass('text-muted text-warning').addClass('text-danger');
        } else {
            countElement.removeClass('text-warning text-danger').addClass('text-muted');
        }
    }
</script>
</body>
</html>
